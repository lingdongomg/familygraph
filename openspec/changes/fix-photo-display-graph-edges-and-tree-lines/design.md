## Context
照片上传流程涉及客户端与云函数的协作，当前存在注释与实际流程不一致的问题。图谱推断规则经过系统分析后发现缺失 5 条规则，需要对所有 10 种关系类型的推断场景做完整覆盖。图谱连线改造需要在 Canvas 绘制层面对亲子边进行分组和重绘。

## Goals / Non-Goals
- Goals:
  - 修复照片上传后无法显示的问题（包括历史数据修复）
  - 实现完整的 7 条推断规则，覆盖所有 4 类关系创建场景
  - 亲子连线采用 bracket/tree 形，提升多子女可读性
  - 让删除成员入口更容易被发现
- Non-Goals:
  - 不重构整个照片上传架构（保持先上传后记录的模式）
  - 不改变兄弟姐妹边或配偶边的绘制样式
  - 不增加批量删除成员功能
  - 不做跨代推断（如自动推断祖孙关系），仅推断直接相邻的一层关系

## Decisions
- **照片流程**：保持客户端先上传云存储、再调云函数记录的模式，只修正注释并提供历史数据修复脚本。
- **推断规则架构**：所有 7 条规则在 create 函数中顺序执行，每条规则独立查询并创建边。虽然有多次数据库操作，但创建成员是低频操作（每次仅创建一个人），性能可接受。
- **兄弟姐妹类型判定**：
  - Rule 5（同辈→同辈）：新人相对于已有同辈的类型，根据新人的性别选择 OLDER/YOUNGER。由于缺少精确出生年月，默认新创建的同辈视为与参照人同类型关系的延伸（使用 REVERSE_RELATION 推导）。
  - Rule 6（子代→同辈）：新子女相对于已有子女，默认新创建的视为 YOUNGER（较年幼），根据性别选 YOUNGER_BROTHER/YOUNGER_SISTER。
- **配偶推断的性别适配**（Rule 4）：根据新父母性别和已有父母性别确定 HUSBAND/WIFE（新人 male → HUSBAND→已有, 新人 female → WIFE→已有）。
- **Bracket 连线算法**：采用简单的分组+中点策略——对同一父母的子女按 X 坐标排列，横线连接最左和最右子女的 X，竖线从父母 Y 到横线 Y（取父母和子女 Y 中点），再从横线到每个子女。
- **历史数据修复**：通过列举云存储文件路径反查填充 `file_id`，需要兼容两种路径模式。

## 推断规则完整矩阵

| 创建的关系类型 | 规则 | 推断内容 | 查找方式 |
|---|---|---|---|
| **同辈** (SIBLING_TYPES) | Rule 1 (已有) | 参照人的父母 → 新同辈的父母 | 参照人的 FATHER/MOTHER 边 |
| **同辈** (SIBLING_TYPES) | Rule 5 (新增) | 参照人的其他同辈 → 新同辈的同辈 | 参照人的 SIBLING 边（排除新人自身） |
| **子代** (CHILD_TYPES) | Rule 2 (已有) | 参照人的配偶 → 新子代的另一父母 | 参照人的 SPOUSE 边 |
| **子代** (CHILD_TYPES) | Rule 6 (新增) | 参照人的其他子女 → 新子代的同辈 | 参照人反向的 FATHER/MOTHER 边（即 from_id 指向 ref 的 SON/DAUGHTER 边）|
| **亲代** (PARENT_TYPES) | Rule 3 (新增) | 参照人的同辈 → 新亲代的子女 | 参照人的 SIBLING 边 |
| **亲代** (PARENT_TYPES) | Rule 4 (新增) | 参照人的另一亲代 → 新亲代的配偶 | 参照人的 FATHER/MOTHER 边（排除新人自身）|
| **配偶** (SPOUSE_TYPES) | Rule 7 (新增) | 参照人的子女 → 新配偶的子女 | 参照人反向的 FATHER/MOTHER 边（即 from_id 指向 ref 的 SON/DAUGHTER 边）|

## Risks / Trade-offs
- 7 条规则在一次创建中可能产生大量数据库操作（尤其是家庭成员较多时），但创建成员是低频操作，可接受
- 兄弟姐妹的 OLDER/YOUNGER 判定在缺少精确出生日期时不完全准确，但这是已知的 V1 限制
- 历史照片的云存储路径格式可能不统一，修复脚本需要处理多种情况
- Bracket 连线在节点位置非常紧密时可能出现视觉重叠，需要设置最小间距

## Open Questions
- 无
