## MODIFIED Requirements

### Requirement: 图谱触摸交互
系统 SHALL 在图谱画布上支持双指缩放、拖拽平移和点击选择交互。点击整个节点区域（包括圆形头像和下方标签）均 MUST 触发节点选中事件。

#### Scenario: 点击节点头像区域
- **WHEN** 用户点击图谱中某个人物节点的圆形头像区域
- **THEN** 系统触发 nodetap 事件并跳转到该人物的详情页

#### Scenario: 点击节点标签区域
- **WHEN** 用户点击图谱中某个人物节点下方的文字标签区域
- **THEN** 系统同样触发 nodetap 事件并跳转到该人物的详情页

#### Scenario: 拖拽平移
- **WHEN** 用户在画布空白区域拖拽
- **THEN** 图谱视口按拖拽偏移量平移

#### Scenario: 双指缩放
- **WHEN** 用户执行双指捏合手势
- **THEN** 图谱以捏合中心为原点等比缩放

### Requirement: 图谱节点标签
系统 SHALL 在每个节点下方显示标签，展示该 Person 的显示称谓。当前用户的节点标签 MUST 显示 "我"。其他节点 SHALL 优先显示自定义昵称，其次为用户选用的称呼表覆盖称谓，再次为系统计算的亲属称谓，最后为姓名。

#### Scenario: 当前用户节点标签
- **WHEN** 图谱渲染当前用户自己的节点
- **THEN** 标签显示 "我"

#### Scenario: 有自定义昵称的节点
- **WHEN** 当前用户为某 Person 设置了自定义昵称（custom_title）
- **THEN** 标签显示自定义昵称

#### Scenario: 用户选用了自定义称呼表且有覆盖
- **WHEN** 当前用户选用了某称呼表，且该称呼表中有对应路径的覆盖称谓
- **THEN** 标签显示称呼表中的覆盖称谓

#### Scenario: 仅有系统计算称谓的节点
- **WHEN** 未设置自定义昵称、无称呼表覆盖，但可以计算亲属称谓
- **THEN** 标签显示系统正式亲属称谓（FORMAL_TITLE_MAP）

### Requirement: Canvas 图谱渲染
系统 SHALL 在微信小程序 Canvas 2D 元素上渲染家庭图谱，支持高 DPI。节点 MUST 显示圆形头像（无头像时回退为姓名首字），背景色 SHALL 按性别区分。不同关系类型 MUST 使用不同边样式: 配偶为红色实线、亲子为蓝色实线、兄弟姐妹为灰色虚线。

#### Scenario: 渲染有头像的节点
- **WHEN** 某 Person 有已加载的头像图片
- **THEN** 节点显示圆形裁剪的头像

#### Scenario: 渲染无头像的节点
- **WHEN** 某 Person 没有头像
- **THEN** 节点在按性别着色的背景上显示姓名首字（男性蓝色调、女性粉色调）

#### Scenario: 渲染关系边
- **WHEN** 两人为配偶关系
- **THEN** 边渲染为红色实线（宽度 2）
- **WHEN** 两人为亲子关系
- **THEN** 边渲染为蓝色实线（宽度 1.5）
