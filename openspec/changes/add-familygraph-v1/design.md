## 背景
亲记是一个基于微信云开发构建的绿地微信小程序。它以图模型管理家庭关系数据，计算中国亲属称谓，并在 Canvas 上渲染交互式力导向图。系统将 Person 数据分为共享层（客观属性，所有人看到同一份）和私人覆盖层（每用户各存一份的备注数据），并通过 AES 加密保护敏感字段。

## 目标 / 非目标
- **目标**:
  - 交付完整的、功能齐全的 V1 版本，覆盖产品规格中定义的全部 12 个能力
  - 通过加密、角色访问控制和数据分层确保数据安全
  - 为最多 200 名成员的家庭提供流畅的图谱可视化
  - 支持微信订阅消息用于关键生命周期事件通知
  - 支持五代亲属称谓（高祖辈至玄孙辈）
- **非目标**:
  - 视频上传（推迟至 V1.1）
  - 超过五代的亲属称谓
  - 多语言支持
  - Web 或 Android/iOS 原生版本
  - 自动化测试框架（V1 采用手动测试）

## 架构概览

### 系统分层
```
┌─────────────────────────────────┐
│ 微信小程序（前端）                │
│ 页面 + 组件 + 工具模块            │
├─────────────────────────────────┤
│ 云函数（后端）                    │
│ 认证 + 业务逻辑 + 数据合并        │
├─────────────────────────────────┤
│ 云数据库（存储）                  │
│ 11 个集合 + 索引                 │
├─────────────────────────────────┤
│ 云存储（COS）                    │
│ 照片 + 头像 + 缩略图             │
└─────────────────────────────────┘
```

### 数据模型（11 个集合）
- `users` — 微信用户账号（openid 加密存储）
- `families` — 家庭组，含邀请码和存储配额
- `family_members` — 用户-家庭关联表，含角色（owner/member/restricted）
- `persons` — 家庭成员共享字段（name, gender, birth_year, is_deceased, avatar, generation）
- `relationships` — Person 之间的有向关系边
- `person_notes` — 每用户对 Person 的私人覆盖层（phone, wechat_id, birth_date, city, occupation, custom_title, remark）
- `photos` — 照片元数据及云存储文件 ID
- `photo_tags` — 照片上的位置标记
- `edit_history` — 审计日志（仅共享字段），含修改前快照用于回滚
- `join_requests` — 待处理/已通过/已拒绝的家庭加入申请
- `share_links` — 访客只读分享链接码

### 数据分层模型

```
┌──────────────────────────────────────────┐
│ Person 卡片                               │
├──────────────┬───────────────────────────┤
│ 共享层        │ 私人覆盖层                 │
│ (persons集合) │ (person_notes集合,每用户一份)│
├──────────────┼───────────────────────────┤
│ 姓名          │ 手机号（AES 加密）          │
│ 性别          │ 微信号（AES 加密）          │
│ 出生年份      │ 完整出生日期                │
│ 是否已故      │ 城市/地址                   │
│ 头像          │ 职业                       │
│ 辈分          │ 自定义称呼                  │
│              │ 备注                        │
├──────────────┼───────────────────────────┤
│ 全体家庭成员   │ 仅记录者自己可见             │
│ 及访客可见     │                            │
└──────────────┴───────────────────────────┘
```

### 安全分层
1. 传输层: 微信强制 HTTPS
2. 认证: 微信 openid 验证
3. 授权: 云函数角色检查（Owner/Member/Restricted/Guest）
4. 数据分层: 共享字段全体可见，私人覆盖字段仅记录者可见
5. 加密: AES-256-CBC 加密 openid、person_notes 中的 phone 和 wechat_id
6. 审计: edit_history 审计日志（仅共享字段），支持回滚
7. 隔离: 云开发环境隔离
8. 图片安全: 临时签名 URL（2 小时过期）

### 关键算法
- **亲属称谓计算**: 关系图上的 BFS 最短路径 + 查找表（FORMAL_TITLE_MAP，含约 150+ 条目，覆盖五代）
- **力导向图布局**: 自定义实现（约 300 行），包含斥力、引力、辈分层约束和配偶对齐
- **图片压缩**: 客户端基于 Canvas 缩放至最大 1080p + 80% JPEG 质量

## 技术决策
- **Canvas 2D 而非 ECharts/D3**: 小程序环境限制；自定义实现保持包体积小
- **AES-256-CBC 加密**: 标准对称加密；密钥来自环境变量
- **所有写操作通过云函数**: 客户端不直接写数据库；实现集中认证和审计
- **BFS 计算亲属路径**: 对小规模图（<200 节点）简单且正确；最大深度 5
- **文档型数据库而非关系型**: 与微信云数据库一致；反范式化提升查询性能
- **订阅消息而非模板消息**: 微信已弃用模板消息；订阅消息是当前标准
- **共享层 + 私人覆盖层而非字段级隐私控制**: 手机号、地址等信息每个人了解的不同，天然适合"通讯录备注"模式；移除 privacy_settings 简化系统
- **edit_history 仅记录共享字段变更**: 私人覆盖字段属于用户个人数据，记录到全家可见的编辑历史中不合理

## 风险 / 权衡
- **Canvas 性能**: O(n^2) 力模拟对超大家庭（>150 节点）可能卡顿 → 缓解措施: 迭代次数上限 100 次，预计算布局
- **云数据库 20 条批量限制**: 大家庭需要分页 → 缓解措施: 尽可能使用聚合查询
- **订阅消息授权**: 用户需按消息类型逐一授权 → 缓解措施: 在关键时刻提示授权（创建家庭、审批成员时）
- **单区域云部署**: 无多区域冗余 → 对 V1 规模可接受
- **信息孤岛**: 私人覆盖字段互不可见可能导致重复录入 → 这是"通讯录备注"模式的本质特征，可接受
- **person_notes 查询**: 每次查看详情需额外查询 person_notes → 单次额外查询，性能影响可忽略

## 待解决问题
- 无（所有讨论点 A-J 均已解决）
