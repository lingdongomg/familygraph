# 变更: 亲记 V1 — 完整产品实现

## 为什么
从零构建"亲记"(FamilyGraph) V1 版本，一款帮助中国家庭记录、可视化和分享家庭关系的微信小程序。目前没有任何现有代码，这是一个绿地项目，涵盖从用户认证到家庭图谱可视化的所有核心产品能力。

## 变更内容
- **用户认证**: 微信登录、用户资料管理
- **家庭管理**: 创建/删除家庭、邀请码、加入/审批流程
- **成员管理**: 家庭成员记录的增删改查，共享字段 + 私人覆盖层模式
- **关系管理**: 有向关系边，自动创建反向边
- **亲属称谓系统**: 基于 BFS 的五代中国亲属称谓计算 + 自定义昵称
- **家庭图谱可视化**: 自定义 Canvas 2D 力导向布局，支持触摸交互
- **照片管理**: 上传（1080p 压缩）、相册（每人 20 张，每家庭 500MB）、照片标记
- **数据分层**: Person 数据拆分为共享层（客观属性）和私人覆盖层（每用户独立的备注数据）
- **编辑历史与回滚**: 审计日志（仅共享字段），基于快照的回滚（仅 Owner）
- **分享**: 访客只读链接（7 天过期），展示共享字段 + 图谱
- **通知**: 微信订阅消息，用于加入请求和审批
- **定时任务**: 每日清理过期邀请码、请求、分享链接和旧历史记录

## 已确认的决策
| # | 决策 | 结论 |
|---|------|------|
| A | 已绑定的 Person 能否被重新绑定 | 直接拒绝 |
| B | 加入时不选择 Person | V1 不允许（安全风险） |
| C | 访客图谱视图 | 展示图谱；节点点击仅显示共享字段 |
| D | 应用名称 | 亲记 |
| E | 订阅消息 | 是，用于加入请求和审批 |
| F | 时间线 | 约 6 周（42 天），可接受 |
| G | 私人字段范围 | 所有可编辑字段均为私人覆盖模式 |
| H | 共享手机号 | 移除，手机号完全改为私人备注 |
| I | UI 展示模式 | 仅保留私人模式，不再有共享/私人混合展示 |
| J | 亲属称谓深度 | 从四代扩展到五代 |

## 影响范围
- 涉及规格: 全部新建（12 个能力）
- 涉及代码: 全部代码库（绿地项目）
- 数据模型: 11 个云数据库集合（无 privacy_settings）
- 云函数: 8 个领域 ~24 个函数（无 person/updatePrivacy）
- 小程序页面: 17 个页面，5 个组件
