## 新增需求

### 需求: 删除家庭
系统应仅允许 Owner 删除家庭及所有关联数据。

#### 场景: Owner 删除家庭
- **当** Owner 请求删除家庭
- **则** 系统删除与该家庭关联的所有成员（persons）、关系（relationships）、照片（photos）、照片标记（photo_tags）、编辑历史（edit_history）、加入申请（join_requests）、分享链接（share_links）、家庭成员（family_members）和所有用户的私人备注（person_notes）
- **且** 从所有成员用户的 `family_ids` 数组中移除该家庭 ID

#### 场景: 非 Owner 尝试删除
- **当** Member 或 Restricted 用户尝试删除家庭
- **则** 系统拒绝请求并返回权限错误

### 需求: 创建家庭
系统应允许已认证用户创建新的家庭组。创建家庭时应同时创建创建者（Owner）的 Person 记录并绑定到其用户账号。

#### 场景: 创建家庭并生成 Owner 的 Person
- **当** 用户提供家庭名称和本人信息（姓名、性别、出生年份）
- **则** 系统创建一条 `families` 记录，用户为 Owner
- **且** 创建一条 `persons` 记录，绑定到该用户 ID
- **且** 创建一条 `family_members` 记录，角色为 "owner"
- **且** 将家庭 ID 添加到用户的 `family_ids` 数组中

### 需求: 生成邀请码
系统应允许 Owner 和 Member 用户生成 6 位字母数字邀请码，有效期 7 天。

#### 场景: 生成新邀请码
- **当** Owner 或 Member 请求生成新邀请码
- **则** 系统生成一个唯一的 6 位邀请码
- **且** 在家庭记录上存储该邀请码，有效期 7 天，状态为激活
- **且** 使该家庭之前激活的邀请码失效

#### 场景: Restricted 用户尝试生成邀请码
- **当** Restricted 用户尝试生成邀请码
- **则** 系统拒绝请求并返回权限错误

### 需求: 通过邀请码加入家庭
系统应允许用户通过提供有效邀请码并选择一个未绑定的 Person 来申请加入家庭。

#### 场景: 有效邀请码，选择未绑定 Person
- **当** 用户提供有效（激活且未过期）的邀请码并选择一个未绑定的 Person
- **则** 系统创建一条 `join_requests` 记录，状态为 "pending"，48 小时过期
- **且** 通过订阅消息通知家庭的 Owner 和 Member

#### 场景: 过期或无效邀请码
- **当** 用户提供过期或无效的邀请码
- **则** 系统拒绝请求并返回错误消息

#### 场景: 选择了已绑定的 Person
- **当** 用户选择一个已被其他用户绑定的 Person
- **则** 系统拒绝请求并提示 "该成员已被其他用户绑定"

### 需求: 审批加入申请
系统应允许 Owner 和 Member 用户审批（通过或拒绝）待处理的加入申请。任一 Owner 或 Member 的单独审批即可通过。

#### 场景: 通过加入申请
- **当** Owner 或 Member 通过一个待处理的加入申请
- **则** 系统将申请状态设为 "approved"
- **且** 创建一条 `family_members` 记录，角色为 "member"
- **且** 将 Person 的 `bound_user_id` 设为申请人
- **且** 将家庭 ID 添加到申请人的 `family_ids` 数组中
- **且** 通过订阅消息通知申请人

#### 场景: 拒绝加入申请
- **当** Owner 或 Member 拒绝一个待处理的加入申请
- **则** 系统将申请状态设为 "rejected"，可附带拒绝原因
- **且** 通过订阅消息通知申请人

### 需求: 退出家庭
系统应允许 Member 和 Restricted 用户退出家庭。Owner 在转让所有权或删除家庭之前不能退出。

#### 场景: 成员退出家庭
- **当** Member 或 Restricted 用户选择退出家庭
- **则** 系统删除其 `family_members` 记录
- **且** 解绑 Person（将 `bound_user_id` 设为 null）
- **且** 从用户的 `family_ids` 数组中移除该家庭 ID

#### 场景: Owner 尝试退出
- **当** Owner 在未转让所有权的情况下尝试退出
- **则** 系统拒绝请求并提示必须先转让所有权

### 需求: 修改成员角色
系统应仅允许 Owner 在 "member" 和 "restricted" 之间修改成员角色。

#### 场景: Owner 将成员降级为 restricted
- **当** Owner 将某成员的角色修改为 "restricted"
- **则** 系统更新 `family_members` 记录的角色为 "restricted"

#### 场景: 非 Owner 尝试修改角色
- **当** 非 Owner 用户尝试修改成员角色
- **则** 系统拒绝请求并返回权限错误
