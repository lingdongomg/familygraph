<view class="container">
  <view class="loading-container" wx:if="{{loading}}">
    <text class="loading-text">加载中...</text>
  </view>

  <block wx:else>
    <!-- Current adopted title map -->
    <view class="card">
      <view class="section-title">当前使用的称呼表</view>
      <view class="info-row" wx:if="{{adoptedMapName}}">
        <text class="info-value">{{adoptedMapName}}</text>
        <text class="action-text" bindtap="onClearAdopted">恢复默认</text>
      </view>
      <view class="info-row" wx:else>
        <text class="info-empty">使用系统默认称呼</text>
      </view>
    </view>

    <!-- My title maps -->
    <view class="card">
      <view class="section-header">
        <text class="section-title">我的称呼表</text>
        <text class="action-text" bindtap="onCreateMap">+ 新建</text>
      </view>

      <view wx:if="{{myMaps.length === 0}}" class="empty-state">
        <text class="info-empty">暂无自定义称呼表</text>
      </view>

      <view
        class="list-item titlemap-item"
        wx:for="{{myMaps}}"
        wx:key="_id"
      >
        <view class="item-content" data-id="{{item._id}}" bindtap="onEditMap">
          <text class="item-title">{{item.name}}</text>
          <text class="item-subtitle">{{item.overrideCount}} 项覆盖 · {{item.is_shared ? '已分享' : '未分享'}}</text>
        </view>
        <view class="item-actions">
          <text class="action-text" data-id="{{item._id}}" bindtap="onUseMap">使用</text>
          <text class="action-text danger-text" data-id="{{item._id}}" bindtap="onDeleteMap">删除</text>
        </view>
      </view>
    </view>

    <!-- Shared title maps from others -->
    <view class="card" wx:if="{{sharedMaps.length > 0}}">
      <view class="section-title">其他成员分享的称呼表</view>

      <view
        class="list-item titlemap-item"
        wx:for="{{sharedMaps}}"
        wx:key="_id"
      >
        <view class="item-content">
          <text class="item-title">{{item.name}}</text>
          <text class="item-subtitle">{{item.overrideCount}} 项覆盖</text>
        </view>
        <view class="item-actions">
          <text class="action-text" data-id="{{item._id}}" bindtap="onUseMap">使用</text>
        </view>
      </view>
    </view>

    <!-- Edit map dialog -->
    <view class="modal-mask" wx:if="{{showEditor}}" bindtap="onCloseEditor">
      <view class="modal-content" catchtap>
        <view class="modal-header">
          <text class="modal-title">{{editingMapId ? '编辑称呼表' : '新建称呼表'}}</text>
          <text class="modal-close" bindtap="onCloseEditor">×</text>
        </view>

        <view class="form-group">
          <text class="form-label">名称</text>
          <input
            class="form-input"
            placeholder="如：我们家的称呼习惯"
            value="{{editorName}}"
            bindinput="onEditorNameInput"
            maxlength="30"
          />
        </view>

        <view class="form-group">
          <view class="switch-row">
            <text class="form-label">分享给家庭成员</text>
            <switch checked="{{editorShared}}" bindchange="onEditorSharedChange" color="#8B4513" />
          </view>
        </view>

        <!-- Override entries -->
        <view class="section-title override-title">称谓覆盖项</view>

        <view class="override-list">
          <view class="override-item" wx:for="{{editorOverrides}}" wx:key="key">
            <text class="override-key">{{item.displayKey}}</text>
            <text class="override-arrow">→</text>
            <text class="override-value">{{item.value}}</text>
            <text class="override-delete" data-key="{{item.key}}" bindtap="onDeleteOverride">×</text>
          </view>
        </view>

        <!-- Option-based path builder -->
        <view class="path-builder">
          <view class="path-builder-label">添加覆盖项</view>

          <!-- Relation path steps -->
          <view class="path-steps">
            <view class="path-step" wx:for="{{pathSteps}}" wx:key="index">
              <text class="path-step-prefix" wx:if="{{index > 0}}">的</text>
              <picker
                mode="selector"
                range="{{relationOptions}}"
                value="{{item.pickerIndex}}"
                data-idx="{{index}}"
                bindchange="onPathStepChange"
              >
                <view class="path-step-picker {{item.label ? '' : 'path-step-placeholder'}}">
                  {{item.label || '选择关系'}}
                </view>
              </picker>
              <text class="path-step-remove" data-idx="{{index}}" bindtap="onRemovePathStep">×</text>
            </view>
          </view>

          <view class="path-step-add" wx:if="{{pathSteps.length < 5}}" bindtap="onAddPathStep">
            <text>+ 添加{{pathSteps.length > 0 ? '下一级' : ''}}关系</text>
          </view>

          <!-- Gender toggle -->
          <view class="gender-row" wx:if="{{pathSteps.length > 0}}">
            <text class="form-label">性别</text>
            <view class="gender-toggle">
              <view
                class="gender-btn {{overrideGender === 'male' ? 'gender-btn-active' : ''}}"
                data-gender="male"
                bindtap="onGenderChange"
              >男</view>
              <view
                class="gender-btn {{overrideGender === 'female' ? 'gender-btn-active' : ''}}"
                data-gender="female"
                bindtap="onGenderChange"
              >女</view>
            </view>
          </view>

          <!-- Title value input + add button -->
          <view class="override-add" wx:if="{{pathSteps.length > 0}}">
            <input
              class="form-input override-input"
              placeholder="输入称谓 如 阿公"
              value="{{newOverrideValue}}"
              bindinput="onNewOverrideValueInput"
              maxlength="20"
            />
            <view class="remark-add-btn {{overrideGender && newOverrideValue ? '' : 'remark-add-btn-disabled'}}" bindtap="onAddOverride">
              <text>添加</text>
            </view>
          </view>
        </view>

        <view class="modal-footer">
          <view class="btn-primary" bindtap="onSaveMap">保存</view>
        </view>
      </view>
    </view>
  </block>
</view>
